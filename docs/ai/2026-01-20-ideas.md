# Codebase Improvement Suggestions

**Date:** 2026-01-20
**Analyzed by:** Claude (Opus 4.5)

---

## Quick Wins (< 1 hour)

### 1. Add CLAUDE.md for repository documentation
**What:** Create a CLAUDE.md file with development guidelines, architecture overview, and setup instructions.
**Why:** Improves onboarding for AI assistants and contributors; currently no repo-specific instructions exist.
**Where:** `/CLAUDE.md` (root)

### 2. Add missing test for runner.js
**What:** The `runner.js` module (246 lines) has no test file despite containing critical business logic (`runAllDue`, `runJobNow`, `checkMissed`).
**Why:** Core execution logic is untested; regression bugs could go unnoticed.
**Where:** `src/runner.js` - create `src/runner.test.js`

### 3. Export MIN_INTERVAL_MS constant from index.js
**What:** `MIN_INTERVAL_MS` is defined in `launchd.js:31` but not exported from the main entry point.
**Why:** Users may need this constant to validate job intervals before registration.
**Where:** `src/index.js:28` - add to exports

### 4. Add JSDoc for Job type in CLI
**What:** The CLI (`bin/cli.js`) imports but doesn't document the Job type for IDE support.
**Why:** Better IDE autocompletion and type checking for maintainers.
**Where:** `bin/cli.js:6` - add `@typedef` import

### 5. Fix duplicate sound in array
**What:** `src/actions/index.js:11` and `src/actions/index.js:18` both list 'Blow' in the sounds array.
**Why:** Minor bug; wastes array space and could confuse users listing available sounds.
**Where:** `src/actions/index.js:18` - remove duplicate 'Blow'

---

## Medium Effort (1-4 hours)

### 6. Add test coverage for actions/index.js
**What:** The `actions/index.js` module (utils: playSound, speak, notify) has no tests.
**Why:** macOS-specific utilities are critical for user notifications; should have mocked tests.
**Where:** Create `src/actions/index.test.js` with mocked execSync

### 7. Add validation for job ID format
**What:** Job IDs are used in file paths, plist labels, and log files but aren't validated.
**Why:** Invalid characters (e.g., `/`, `..`, spaces) could cause security issues or file system errors.
**Where:** `src/registry.js:104` (registerFile) and `src/scheduler.js` - add ID validation

### 8. Improve error messages with actionable suggestions
**What:** Some error messages are generic (e.g., `src/scheduler.js:75` "no schedule or interval").
**Why:** Better DX; users should know exactly how to fix the issue.
**Where:**
- `src/scheduler.js:75` - suggest adding schedule or interval
- `src/cron-parser.js:206-207` - improve unrecognized pattern message

### 9. Add dry-run mode to sync command
**What:** The `sync` command immediately modifies launchd without preview.
**Why:** Users want to see what will change before applying; prevents accidental modifications.
**Where:** `bin/cli.js:528-596` - add `--dry-run` flag

### 10. Add retry logic for failed jobs
**What:** Failed jobs (`runner.js:59-64`) notify but don't retry; they wait for next scheduled run.
**Why:** Transient failures (network, etc.) could benefit from immediate retry with backoff.
**Where:** `src/runner.js:59-65` - add configurable retry with exponential backoff

### 11. Add test for CLI commands
**What:** The CLI (`bin/cli.js`, 742 lines) has no integration tests.
**Why:** CLI is the primary user interface; changes could break user workflows.
**Where:** Create `bin/cli.test.js` with spawned process tests

---

## Larger Initiatives

### 12. Add TypeScript migration path
**What:** The codebase uses JSDoc for types but could benefit from full TypeScript.
**Why:** Better type safety, IDE support, and catches errors at compile time. The `types/index.d.ts` already exists (generated), showing intent.
**Where:** All `src/*.js` files; `tsconfig.json` is already configured

### 13. Add job dependency/ordering support
**What:** Jobs run independently; no way to specify "job B runs after job A completes".
**Why:** Common use case: backup before cleanup, build before deploy.
**Where:** New feature in `src/scheduler.js` and `src/runner.js`

### 14. Add web dashboard for monitoring
**What:** Create a local web UI to view job status, logs, and history.
**Why:** CLI is powerful but a dashboard provides better visibility for non-technical users.
**Where:** New `src/dashboard/` directory with simple HTTP server

### 15. Add job execution history/metrics
**What:** Only last run time is stored (`state.json`); no history of execution duration, success rate, etc.
**Why:** Users can't identify slow or flaky jobs; no trend analysis possible.
**Where:** `src/state.js` - add history array with configurable retention

### 16. Add configuration file support
**What:** All configuration is via CLI flags; no `.cron-burgundyrc` or similar.
**Why:** Users want persistent defaults (log level, notification preferences, etc.).
**Where:** New `src/config.js` with cosmiconfig integration

### 17. Improve parsePlistFilename for hyphenated namespaces
**What:** `src/launchd.js:453-461` - heuristic assumes first dot separates namespace from jobId.
**Why:** Job IDs with dots (e.g., `my.job.name`) in non-namespaced files will be misparsed.
**Where:** `src/launchd.js:437-462` - improve parsing or document limitation

---

## Code Quality Observations

### Positives
- **Well-structured modules** - clear separation of concerns (scheduler, registry, state, lock, logger)
- **Good test coverage** for core modules (cron-parser, scheduler, registry, state, lock, launchd)
- **JSDoc types** throughout for IDE support
- **Atomic file operations** with proper locking (`state.js`, `lock.js`)
- **Log rotation** implemented (`logger.js:36-57`)
- **Graceful exit handling** with lock cleanup (`lock.js:14-24`)

### Areas for Improvement
- **CLI is 742 lines** - could be split into command-specific files
- **No runner.js tests** - critical module lacks test coverage
- **No actions tests** - macOS utilities untested
- **Duplicate code** in pause/unpause handlers (`cli.js:373-443` and `cli.js:445-517`)
- **Magic strings** - plist paths, label prefixes could be centralized constants

---

## Recommended Next Task

**Create runner.test.js** - The runner module is the heart of job execution and currently has zero test coverage. Testing `runAllDue`, `runJobNow`, and `checkMissed` would:

1. Prevent regressions in core functionality
2. Document expected behavior
3. Enable confident refactoring
4. Complete the test coverage story (all other core modules have tests)

This is the highest-impact improvement given the current codebase state.

### Alternative Tasks
1. **Add dry-run to sync** - Low risk, high user value
2. **Add CLAUDE.md** - Quick documentation win
3. **Fix duplicate 'Blow'** - Trivial fix, shows attention to detail
